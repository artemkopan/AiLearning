services:
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: backend-runtime
      secrets:
        - host_gradle_properties
    env_file:
      - .env
    environment:
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-2.5-flash}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:8081}
      PORT: ${PORT:-8080}
      PROJECTS_ROOT: /docker/shared
      HOOKS_DIR: /docker/shared/ai-learning/scripts
      BACKEND_HOST_PORT: ${BACKEND_HOST_PORT:-18080}
      BACKEND_BASE_URL: ${BACKEND_BASE_URL:-}
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
    working_dir: /docker/shared/ai-learning
    command:
      - /bin/bash
      - -lc
      - |
        set -euo pipefail
        /opt/app/backend/bin/backend &
        BACKEND_PID=$$!
        ./gradlew :web-host:jsBrowserDevelopmentRun --no-daemon &
        WEB_PID=$$!
        trap 'kill $${BACKEND_PID} $${WEB_PID} 2>/dev/null || true' SIGINT SIGTERM EXIT
        wait -n $${BACKEND_PID} $${WEB_PID}
        STATUS=$$?
        kill $${BACKEND_PID} $${WEB_PID} 2>/dev/null || true
        wait $${BACKEND_PID} $${WEB_PID} 2>/dev/null || true
        exit $${STATUS}
    expose:
      - "8080"
      - "8081"
    ports:
      - "${BACKEND_HOST_PORT:-18080}:8080"
      - "${WEB_HOST_PORT:-18081}:8081"
    networks:
      - ai-learning-bridge
    volumes:
      - "${HOME}/projects:/docker/shared"
      - "./docker/backend:/docker/backend"
      - "./docker/backend/.m2:/home/developer/.m2"
      - "./docker/backend/.android:/home/developer/.android"
      - "./docker/backend/android-sdk:/opt/android-sdk"
      - "./docker/backend/.kotlin:/home/developer/.kotlin"
      - "./docker/backend/.cursor:/home/developer/.cursor"
      - "./docker/backend/.claude:/home/developer/.claude"
      - "./docker/backend/.claude/.claude.json:/home/developer/.claude.json"

networks:
  ai-learning-bridge:
    driver: bridge

secrets:
  host_gradle_properties:
    file: ${HOME}/.gradle/gradle.properties
